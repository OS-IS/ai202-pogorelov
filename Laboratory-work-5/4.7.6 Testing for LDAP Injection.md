Тестування ін'єкції LDAP
========================

| ID |
| --- |
| WSTG-INPV-06 |

Резюме
------

Протокол LDAP (Lightweight Directory Access Protocol) використовується для зберігання інформації про користувачів, хости та багато інших об'єктів. [Ін'єкція LDAP](https://wiki.owasp.org/index.php/LDAP_injection) -- це атака на стороні сервера, яка може дозволити розкрити, змінити або вставити конфіденційну інформацію про користувачів і хости, представлену в структурі LDAP. Це робиться шляхом маніпулювання вхідними параметрами, які потім передаються до внутрішніх функцій пошуку, додавання та зміни.

Веб-програма може використовувати LDAP, щоб дозволити користувачам автентифікувати або шукати інформацію інших користувачів у корпоративній структурі. Метою ін'єкційних атак LDAP є введення метасимволів фільтрів пошуку LDAP у запит, який виконуватиме програма.

[Rfc2254](https://www.ietf.org/rfc/rfc2254.txt) визначає граматику створення фільтра пошуку на LDAPv3 і розширює [Rfc1960](https://www.ietf.org/rfc/rfc1960.txt) (LDAPv2).

Фільтр пошуку LDAP створено в польській нотації, також відомої як [префіксна нотація польської нотації](https://en.wikipedia.org/wiki/Polish_notation) .

Це означає, що умова псевдокоду для пошукового фільтра така:

`find("cn=John & userPassword=mypass")`

буде представлено як:

`find("(&(cn=John)(userPassword=mypass))")`

Логічні умови та агрегації груп у пошуковому фільтрі LDAP можна застосувати за допомогою таких метасимволів:

| метасимвол | Значення |
| --- | --- |
| & | Логічне І |
| | | Логічне АБО |
| ! | Логічне НІ |
| = | Дорівнює |
| ~= | прибл |
| >= | Більше ніж |
| <= | Менше ніж |
| * | Будь-який персонаж |
| () | Групування дужок |

Більш повні приклади того, як створити пошуковий фільтр, можна знайти у відповідному RFC.

Успішне використання вразливості впровадження LDAP може дозволити тестувальнику:

-   Доступ до неавторизованого вмісту
-   Уникайте обмежень програми
-   Збирайте несанкціоновану інформацію
-   Додайте або змініть об'єкти в структурі дерева LDAP.

Цілі тесту
----------

-   Визначте точки впровадження LDAP.
-   Оцініть ступінь тяжкості уколу.

Як тестувати
------------

### Приклад 1: фільтри пошуку

Припустімо, що у нас є веб-програма, яка використовує пошуковий фільтр, подібний до наступного:

`searchfilter="(cn="+user+")"`

екземпляр якого створюється HTTP-запитом таким чином:

`http://www.example.com/ldapsearch?user=John`

Якщо значення `John`замінено на `*`, надсилаючи запит:

`http://www.example.com/ldapsearch?user=*`

фільтр матиме такий вигляд:

`searchfilter="(cn=*)"`

який відповідає кожному об'єкту з атрибутом 'cn', дорівнює будь-чому.

Якщо програма вразлива до впровадження LDAP, вона відображатиме деякі або всі атрибути користувача, залежно від потоку виконання програми та дозволів підключеного користувача LDAP.

Тестер може використовувати метод проб і помилок, вставляючи в параметр `(`, `|`, `&`та `*`інші символи, щоб перевірити програму на наявність помилок.

### Приклад 2: Логін

Якщо веб-додаток використовує LDAP для перевірки облікових даних користувача під час процесу входу та є вразливим до ін'єкції LDAP, можна обійти перевірку автентифікації, вставивши завжди справжній запит LDAP (подібно до ін'єкції SQL і XPATH).

Припустімо, що веб-програма використовує фільтр для відповідності пари користувач/пароль LDAP.

`searchlogin= "(&(uid="+user+")(userPassword={MD5}"+base64(pack("H*",md5(pass)))+"))";`

Використовуючи такі значення:

```
user=*)(uid=*))(|(uid=*
pass=password

```

пошуковий фільтр видасть:

`searchlogin="(&(uid=*)(uid=*))(|(uid=*)(userPassword={MD5}X03MO1qnZdYdgyfeuILPmQ==))";`

що є правильним і завжди вірним. Таким чином, тестувальник отримає статус входу в систему як перший користувач у дереві LDAP.

Інструменти
-----------

-   [Softerra LDAP-браузер](https://www.ldapadministrator.com/)

Список літератури
-----------------

-   [Шпаргалка щодо запобігання ін'єкціям LDAP](https://cheatsheetseries.owasp.org/cheatsheets/LDAP_Injection_Prevention_Cheat_Sheet.html)

### Офіційні документи

-   [Саша Фауст: Впровадження LDAP: чи є ваші програми вразливими?](http://www.networkdls.com/articles/ldapinjection.pdf)
-   [Документ IBM: Розуміння LDAP](https://www.redbooks.ibm.com/redbooks/pdfs/sg244986.pdf)
-   [RFC 1960: Рядкове подання фільтрів пошуку LDAP](https://www.ietf.org/rfc/rfc1960.txt)
-   [Ін'єкція LDAP](https://www.blackhat.com/presentations/bh-europe-08/Alonso-Parada/Whitepaper/bh-eu-08-alonso-parada-WP.pdf)
